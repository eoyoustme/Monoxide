---====== Load spawner ======---

local spawner = loadstring(game:HttpGet("https://raw.githubusercontent.com/RegularVynixu/Utilities/main/Doors/Entity%20Spawner/V2/Source.lua"))()

---====== Create entity ======---

local entity = spawner.Create({
	Entity = {
		Name = "A-200",
		Asset = "rbxassetid://129659469594085",
		HeightOffset = 0
	},
	Lights = {
		Flicker = {
			Enabled = false,
			Duration = 1
		},
		Shatter = true,
		Repair = false
	},
	Earthquake = {
		Enabled = false
	},
	CameraShake = {
		Enabled = true,
		Range = 100,
		Values = {1.5, 20, 0.1, 1}
	},
	Movement = {
		Speed = 60,
		Delay = 2,
		Reversed = false
	},
	Rebounding = {
		Enabled = true,
		Type = "Ambush",
		Min = 2,
		Max = 3,
		Delay = 2
	},
	Damage = {
		Enabled = true,
		Range = 20,
		Amount = 125
	},
	Crucifixion = {
		Enabled = true,
		Range = 40,
		Resist = false,
		Break = true
	},
	Death = {
		Type = "Guiding",
		Hints = {"You die to A-200", "He like A-120 But easy", "If you hear him sound", "HIDE Remember this"},
		Cause = ""
	}
})

---====== Logic chasing player khi không núp ======---

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local chaseConnection

entity:SetCallback("OnSpawned", function()
	print("Entity has spawned")

	-- Tạo sương mù dày đặc màu đỏ
	local lighting = game:GetService("Lighting")
	local atmosphere = Instance.new("Atmosphere")
	atmosphere.Name = "A200Fog"
	atmosphere.Density = 1
	atmosphere.Offset = 0.2
	atmosphere.Color = Color3.fromRGB(200, 0, 0)
	atmosphere.Decay = Color3.fromRGB(100, 0, 0)
	atmosphere.Parent = lighting
end)

entity:SetCallback("OnStartMoving", function()
	print("Entity has started moving")

	chaseConnection = RunService.Heartbeat:Connect(function(deltaTime)
		local player = Players.LocalPlayer
		if not player then return end

		local character = player.Character
		if character and character:FindFirstChild("HumanoidRootPart") then
			local isHiding = character:FindFirstChild("Hiding") or player:GetAttribute("Hidden") == true

			if not isHiding then
				-- Player không núp, di chuyển entity đến gần player giữ tốc độ
				local targetPos = character.HumanoidRootPart.Position
				local model = entity.Model
				if model and model.PrimaryPart then
					local direction = (targetPos - model.PrimaryPart.Position).Unit
					local newPos = model.PrimaryPart.Position + direction * entity.Config.Movement.Speed * deltaTime
					model:SetPrimaryPartCFrame(CFrame.new(newPos, targetPos))
				end
			end
		end
	end)
end)

entity:SetCallback("OnDespawned", function()
	print("Entity has despawned")

	-- Xóa sương mù khi entity biến mất
	local lighting = game:GetService("Lighting")
	local fog = lighting:FindFirstChild("A200Fog")
	if fog then
		fog:Destroy()
	end

	if chaseConnection then
		chaseConnection:Disconnect()
		chaseConnection = nil
	end
end)

---====== Callback OnDamagePlayer với jumpscare mạnh hơn khi giết ======---

entity:SetCallback("OnDamagePlayer", function(newHealth)
	if newHealth == 0 then
		print("Entity has killed the player")

		local player = game.Players.LocalPlayer
		local character = player.Character or player.CharacterAdded:Wait()
		local playerGui = player:WaitForChild("PlayerGui")

		-- Tạo GUI jumpscare
		local screenGui = Instance.new("ScreenGui")
		screenGui.Name = "DeathJumpscareGui"
		screenGui.IgnoreGuiInset = true
		screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
		screenGui.Parent = playerGui

		-- Background đỏ phủ full màn hình, không trong suốt luôn
		local Background = Instance.new("Frame")
		Background.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
		Background.BorderSizePixel = 0
		Background.Size = UDim2.new(1, 0, 1, 0)
		Background.ZIndex = 999
		Background.BackgroundTransparency = 0
		Background.Parent = screenGui

		-- Image jumpscare to rõ ở giữa màn hình
		local imageLabel = Instance.new("ImageLabel")
		imageLabel.Size = UDim2.new(0, 700, 0, 700)
		imageLabel.AnchorPoint = Vector2.new(0.5, 0.5)
		imageLabel.Position = UDim2.new(0.5, 0, 0.5, 0)
		imageLabel.BackgroundTransparency = 1
		imageLabel.Image = "rbxassetid://16249498432" -- Thay ID hình thực tế
		imageLabel.ImageTransparency = 0
		imageLabel.Parent = screenGui

		-- Âm thanh jumpscare lớn và rõ
		local sound = Instance.new("Sound")
		sound.Parent = game.Workspace
		sound.SoundId = "rbxassetid://85271883712040" -- Thay ID âm thanh thực tế
		sound.Volume = 6
		sound.PlaybackSpeed = 1
		sound:Play()

		-- Đợi 4 giây mới ẩn jumpscare và GUI
		task.wait(2)

		screenGui:Destroy()

		-- Giảm HP của player xuống 0 (chắc chắn chết)
		if character:FindFirstChild("Humanoid") then
			character.Humanoid.Health = 0
		end

		local stats = game.ReplicatedStorage:FindFirstChild("GameStats")
		if stats and stats:FindFirstChild("Player_" .. player.Name) then
			stats["Player_" .. player.Name].Total.DeathCause.Value = "A-200"
		end

	else
		print("Entity has damaged the player")
		-- Bạn có thể giữ hoặc chỉnh phần gây damage thường ở đây
	end
end)

---====== Run entity ======---

entity:Run()
